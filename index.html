<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>IRO Downloads App</title>
  <script src='https://api.mapbox.com/mapbox.js/v2.2.1/mapbox.js'></script>
  <link href='https://api.mapbox.com/mapbox.js/v2.2.1/mapbox.css' rel='stylesheet' />
  <link href="https://fonts.googleapis.com/css?family=Josefin+Sans" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Cormorant+Garamond" rel="stylesheet">
  <link href="main.css" rel="stylesheet" type="text/css"/>
  <script src="https://code.jquery.com/jquery-1.8.2.min.js"></script>
  <script src="https://cdn.rawgit.com/vast-engineering/jquery-popup-overlay/1.7.13/jquery.popupoverlay.js"></script>
  <script src="10m.js" type="text/javascript"></script>
</head>
<body>
  <div id="content">
    <img id="touchPan" src="panning.gif">
    <div id='map'></div>
    <div id="header" class="sidebar">
      <!--<audio autoplay loop style="z-index: 10, display: block">
      <source src="danceMusicShort.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
      </audio>-->
      <h1>IOWA RESEARCH ONLINE</h1>
    </div>
    <img id="icon" src="icon.png" width='40' height='40'>
    <div id="navbar" class="sidebar">
      <button type="button" id="abtBtn">ABOUT</button>
      <button type="button" id="faqBtn">FAQ</button>
      <button type="button" id="colBtn">COLLECTIONS</button>
    </div>
    <div id="info" class="sidebar sideinfo">
      <h3 style="text-align: center;">10 MILLION DOWNLOADS</h3>
      <p>&emsp;Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
      <p>&emsp;Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
    </div>
    <div id="faq" class="sidebar sideinfo">
      <h3 style="text-align: center;">FREQUENTLY ASKED QUESTIONS</h3>
    </div>
    <div id="collections" class="sidebar sideinfo">
      <h3 style="text-align: center;">TOP COLLECTIONS</h3>
      <p>Directed and Edited by Eloy Barrag√°n. Publication Date: 1-29-16. A man and a woman explore the tension and eroticism of learning
        amid the lonely geometry of a library's books and chairs. With an original score by the contemporary British composer Peter Mauder.</p>
      <video id="my-video" src="DanceVideo.mp4" type="video/mp4" loop></video>
    </div>
  </div>
  <script>
    //map from IRO downloads html page off of dsph-dev
    L.mapbox.accessToken = 'pk.eyJ1IjoicmNzaGVwYXJkIiwiYSI6IjYwYjI0NzdmNDQwM2YzNTc1ODI2NWZhNTU1ZTVmNjY4In0.ct_UnOxwtV_WIGwzyG0Rxw';
    var map = L.mapbox.map('map', 'mapbox.streets',{
      legendControl: {
        // Any of the valid control positions:
        // https://www.mapbox.com/mapbox.js/api/v2.2.1/l-control/#control-positions
        position: 'bottomleft',
      },
      minZoom: 3,
      maxZoom: 12,
    });
    map.setView([20, 11.5], 3);
    //making sure the map can't pan past the tiles
    var southWest = L.latLng(-89.98155760646617, -180);
    var northEast = L.latLng(89.99346179538875, 180);
    var bounds = L.latLngBounds(southWest, northEast);

    map.setMaxBounds(bounds);
    map.on('drag', function() {
      map.panInsideBounds(bounds, { animate: true });
    });

    var popup = new L.Popup({ autoPan: false });
    var countriesLayer = L.geoJson(milJson,  {
      style: getStyle,
      onEachFeature: onEachFeature
    }).addTo(map);

    function getStyle(feature) {
      return {
        weight: 2,
        opacity: 0.1,
        color: 'black',
        fillOpacity: 0.7,
        fillColor: getColor(feature.properties.Downloads)
      };
    }

    // get color depending on population density value
    function getColor(d) {
      return d > 100000 ? '#8c2d04' :
      d > 50000  ? '#cc4c02' :
      d > 10000  ? '#ec7014' :
      d > 1000  ? '#fe9929' :
      d > 500   ? '#fec44f' :
      d > 25   ? '#fee391' :
      d > 1   ? '#fff7bc' : '#ffffe5';
    }

    function onEachFeature(feature, layer) {
      layer.on({
        click: click,
        //mouseout: mouseout,
        //click: zoomToFeature
      });
    }

    var closeTooltip;

    function click(e) {
      var layer = e.target;
      popup.setLatLng(e.latlng);
      popup.setContent('<div class="marker-title">' + layer.feature.properties.Country + '</div>' + layer.feature.properties.Downloads + ' downloads');
      if (!popup._map) popup.openOn(map);
      window.clearTimeout(closeTooltip);
      // highlight feature
      /*layer.setStyle({
        weight: 3,
        opacity: 0.3,
        fillOpacity: 0.9
      });*/
      if (!L.Browser.ie && !L.Browser.opera) {
        layer.bringToFront();
      }
    }

    function mouseout(e) {
      countriesLayer.resetStyle(e.target);
      closeTooltip = window.setTimeout(function() {
        map.closePopup();
      }, 100);
    }

    function zoomToFeature(e) {
      map.fitBounds(e.target.getBounds());
    }

    map.legendControl.addLegend(getLegendHTML());

    function getLegendHTML() {
      var COUNT = [1, 25, 500, 1000, 10000, 50000, 100000],
      labels = [],
      from, to;
      for (var i = 0; i < COUNT.length; i++) {
        from = COUNT[i];
        to = COUNT[i + 1];
        labels.push(
          '<li><span class="swatch" style="background:' + getColor(from + 1) + '"></span> ' +
          from + (to ? '&ndash;' + to : '+')) + '</li>';
      }
      return '<span>Total downloads</span><ul>' + labels.join('') + '</ul>';
    }

    var ipcRenderer = require('electron').ipcRenderer;
    var video = document.getElementById('my-video')
    var open, insideRotate;
    var touchPan = document.getElementById('touchPan');
    touchPan.addEventListener('click', function() {
      $('#touchPan').hide('slow');
    })

    function idleTimer() {
      var t;
      window.ontouchstart = resetTimer;
      window.ontouchmove = resetTimer;
      window.onscroll = resetTimer;
      window.onload = resetTimer;
      window.onclick = function(){
        $('#touchPan').hide('slow');
        resetTimer();
      }; //checks for clicks anywhere but map tiles
      countriesLayer.on('click', function() {
        $('#touchPan').hide('slow');
        resetTimer()
      }) //checks for clicks on map tiles

      function openChild() {
        video.pause();
        video.currentTime = 0;
        $('#info').hide();
        $('#faq').hide();
        $('#collections').hide();
        ipcRenderer.send('reset')
        $('#touchPan').show('slow');
        var rotate = function(){
          var loop = countriesArray.length;
          var looper = function(){
            if (loop > 0) {
              loop--;
              country = countriesArray[loop][0]
              downloads = countriesArray[loop][1]
              popup.setLatLng(latLngData[country])
              popup.setContent('<div class="marker-title">' + country + '</div>' + downloads + ' downloads')
              popup.openOn(map);
              setTimeout(function() {
                map.closePopup()
              }, 1000);
            }
            else {
              return rotate();
            }
            insideRotate = setTimeout(looper, 1000);
          };
          looper();
        };
        rotate()
        open = setInterval(function() {
          ipcRenderer.send('reset')
        }, 330000) //set this for length of video + amount of break time you want in between playing the video
        map.setView([20, 11.5], 3);
      }

      function resetTimer() {
        clearTimeout(insideRotate);
        clearInterval(open);
        clearTimeout(t);
        t = setTimeout(openChild, 10000);  // time is in milliseconds
      }
    }

    idleTimer();
    $('.leaflet-control-attribution').hide()

    /////////CODE FOR NAVIGATION//////////
    //button for the hamburger icon
    var openNav = document.getElementById('icon')
    openNav.addEventListener('click', function() {
      if($('#header').css('display') == 'none'){
        $('#header').show('slow');
        $('#navbar').show('slow');
        $('#info').show('slow');
      } else {
        $('#header').hide('slow');
        $('#navbar').hide('slow');
        $('#info').hide('slow');
        $('#faq').hide('slow');
        $('#collections').hide('slow');
      }
    })

    //button for basic information
    var abtBtn = document.getElementById('abtBtn')
    abtBtn.addEventListener('click', function() {
      $('#faq').hide('slow');
      $('#collections').hide('slow');
      if($('#info').css('display') == 'none'){
        $('#info').show('slow');
      } else {
        $('#info').hide('slow');
      }
    })

    //button for faqs
    var faqBtn = document.getElementById('faqBtn')
    faqBtn.addEventListener('click', function() {
      $('#info').hide('slow');
      $('#collections').hide('slow');
      if($('#faq').css('display') == 'none'){
        $('#faq').show('slow');
      } else {
        $('#faq').hide('slow');
      }
    })

    //button for collections
    var colBtn = document.getElementById('colBtn')
    colBtn.addEventListener('click', function() {
      $('#info').hide('slow');
      $('#faq').hide('slow');
      video.play();
      if($('#collections').css('display') == 'none'){
        $('#collections').show('slow');
      } else {
        $('#collections').hide('slow');
      }
    })
  </script>
  <script>
    // You can also require other files to run in this process
    require('./renderer.js')
  </script>
</body>
</html>
